<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>ë‚˜ë§Œì˜ ê³„íší‘œ â€“ ALL FEATURES</title>

<!-- PWA -->
<link rel="manifest" href="./manifest.webmanifest">
<meta name="theme-color" content="#22c55e">

<!-- Chart.js (í†µê³„ ê·¸ë˜í”„) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
:root{
  --bg:#f6f7fb; --card:#fff; --ink:#0f172a; --line:#e5e7eb; --muted:#6b7280;
  --primary:#22c55e; --primary-2:#16a34a; --danger:#ef4444;
}
/* === í…Œë§ˆ (ì¶”ê°€ í…Œë§ˆ 3ì¢…) === */
body.theme-default{--bg:#f6f7fb; --card:#fff; --ink:#0f172a; --line:#e5e7eb; --muted:#6b7280; --primary:#22c55e; --primary-2:#16a34a}
body.theme-mint{--bg:#edfdf6; --card:#ffffff; --ink:#0b3b2e; --line:#c9efe1; --muted:#4b7a6b; --primary:#10b981; --primary-2:#059669}
body.theme-lavender{--bg:#f5f2ff; --card:#ffffff; --ink:#2e1b4b; --line:#e3dcff; --muted:#6b5a8e; --primary:#7c3aed; --primary-2:#6d28d9}
body.theme-sunset{--bg:#fff7ed; --card:#ffffff; --ink:#3b1d0f; --line:#ffe2c6; --muted:#8a5d44; --primary:#f97316; --primary-2:#ea580c}

*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',sans-serif;background:var(--bg);color:var(--ink)}
body.dark{filter:none} /* ë‹¤í¬ëª¨ë“œëŠ” í…Œë§ˆ ì„ íƒ ëŒ€ì‹  OS/ë²„íŠ¼ í† ê¸€ë¡œ ìœ ì§€í•˜ë ¤ë©´ ì—¬ê¸°ì— ì¶”ê°€í•´ë„ ë¨ */
.wrap{max-width:1100px;margin:0 auto;padding:16px;padding-bottom:calc(16px + env(safe-area-inset-bottom,0))}
.card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 8px 28px rgba(2,6,23,.06);margin-bottom:16px;padding:16px}
h1,h2{margin:0 0 .6rem}
.muted{color:var(--muted)}
button{cursor:pointer;border:0;border-radius:12px;padding:12px 14px;font-weight:700;min-height:44px}
.btn{background:var(--primary);color:#fff}.btn:hover{background:var(--primary-2)}
.btn-outline{background:transparent;border:1px solid var(--line);color:var(--ink)}
.btn-danger{background:var(--danger);color:#fff}
.icon-btn{padding:10px 12px;min-width:44px}
input,select,textarea{padding:12px;border:1px solid var(--line);border-radius:12px;background:#fff;color:inherit;min-height:44px}
.input-row{display:flex;gap:10px;flex-wrap:wrap}.input-row>*{flex:1 1 180px}
ul{list-style:none;padding:0;margin:12px 0 0}
li.task{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 6px;border-bottom:1px dashed var(--line)}
li.task .text{flex:1;line-height:1.45}
li.task.completed .text{text-decoration:line-through;color:#9aa3ad}
li.task .meta{font-size:12px;color:var(--muted)}
.star{cursor:pointer;margin-left:6px;color:#bdbdbd;font-size:18px}.star.active{color:gold}
/* ì™„ë£Œìœ¨ */
.ring-wrap{position:relative;width:96px;height:96px}
.ring{--p:0;width:96px;height:96px;border-radius:50%;background:conic-gradient(var(--primary) calc(var(--p)*1%),#d1d5db 0)}
.ring::after{content:attr(data-label);position:absolute;inset:14px;border-radius:50%;background:var(--card);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:14px}
/* ì£¼ê°„/ë‹¬ë ¥ ê°€ë¡œ ìŠ¤í¬ë¡¤ */
.h-scroll{overflow:auto;-webkit-overflow-scrolling:touch}
.week{display:grid;grid-template-columns:repeat(7,minmax(160px,1fr));gap:8px;min-width:1120px}
.day{border:1px solid var(--line);border-radius:12px;padding:10px;background:var(--card);display:flex;flex-direction:column;min-height:140px}
.day textarea{flex:1;resize:vertical;min-height:84px}
.calendar{display:grid;grid-template-columns:repeat(7,minmax(120px,1fr));gap:6px;min-width:840px}
.calendar .cell{border:1px solid var(--line);border-radius:10px;padding:10px;min-height:90px}
.calendar .today{outline:2px solid var(--primary);outline-offset:-2px;background:rgba(34,197,94,.12)}
.header-row{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
.badge{font-size:12px;border:1px solid var(--line);padding:6px 10px;border-radius:10px;background:#fff}
/* ëª¨ë‹¬ */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);z-index:10}
.modal.open{display:flex}
.modal .panel{background:var(--card);border:1px solid var(--line);border-radius:16px;max-width:720px;width:min(94vw,720px);padding:16px}
@media (max-width:520px){.input-row>*{flex:1 1 100%}.icon-btn{width:100%}}
</style>
</head>
<body class="theme-default">
<div class="wrap">

  <!-- í—¤ë” -->
  <div class="card">
    <div class="header-row">
      <div>
        <h1>âœ¨ ë‚˜ë§Œì˜ ê³„íší‘œ (ALL-IN-ONE)</h1>
        <div class="muted">ë¹ ë¥¸ ë©”ëª¨ Â· ë‚ ì§œë³„ í•  ì¼ Â· ì™„ë£Œìœ¨ Â· ì£¼ê°„ ë©”ëª¨ Â· ë‹¬ë ¥ Â· ë°˜ë³µ Â· ì•Œë¦¼ Â· í…Œë§ˆ Â· AI ìš”ì•½</div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <select id="themeSel" class="btn-outline" style="min-width:160px">
          <option value="theme-default">í…Œë§ˆ: ê¸°ë³¸</option>
          <option value="theme-mint">í…Œë§ˆ: ë¯¼íŠ¸</option>
          <option value="theme-lavender">í…Œë§ˆ: ë¼ë²¤ë”</option>
          <option value="theme-sunset">í…Œë§ˆ: ì„ ì…‹</option>
        </select>
        <button id="installBtn" class="btn-outline icon-btn" style="display:none">ğŸ“² ì„¤ì¹˜</button>
        <button id="settingsBtn" class="btn-outline icon-btn">âš™ï¸ ì„¤ì •</button>
      </div>
    </div>
  </div>

  <!-- ê°„ë‹¨ To-Do -->
  <div class="card">
    <div class="header-row"><h2>ğŸ“ ê°„ë‹¨ ëª©í‘œ</h2><span class="muted">íƒ­/í´ë¦­ìœ¼ë¡œ ì™„ë£Œ</span></div>
    <div class="input-row">
      <input id="simpleTaskInput" placeholder="ë¹ ë¥¸ ë©”ëª¨ ì¶”ê°€" />
      <button id="simpleAddBtn" class="btn">ì¶”ê°€</button>
    </div>
    <ul id="simpleTaskList"></ul>
  </div>

  <!-- ì˜¤ëŠ˜ì˜ ëª©í‘œ + í•„í„° + ì•Œë¦¼ì‹œê°„ -->
  <div class="card">
    <div class="header-row">
      <h2>ğŸ“… ì˜¤ëŠ˜ì˜ ëª©í‘œ</h2>
      <div class="input-row" style="flex:0 0 auto;gap:8px">
        <input type="date" id="datePick" style="min-width:170px">
        <button id="todayBtn" class="btn-outline">ì˜¤ëŠ˜</button>
        <select id="tagFilter" class="btn-outline" style="min-width:160px">
          <option value="">íƒœê·¸ í•„í„°: ì „ì²´</option>
        </select>
        <input type="time" id="dailyNotifyAt" style="min-width:130px" title="ë§¤ì¼ ì•Œë¦¼ ì‹œê°">
        <button id="notifySave" class="btn-outline">ğŸ”” ì•Œë¦¼ì‹œê° ì €ì¥</button>
      </div>
    </div>

    <div class="input-row" style="margin-top:8px">
      <input id="taskInput" placeholder="ì˜ˆ) ìš´ë™ 30ë¶„  #ê±´ê°•  (â­ì€ í•­ëª©ì˜ ë³„ì„ ëˆŒëŸ¬ ì¤‘ìš” í‘œì‹œ)" />
      <select id="repeatSel" title="ë°˜ë³µ">
        <option value="">ë°˜ë³µ ì—†ìŒ</option>
        <option value="daily">ë§¤ì¼</option>
        <option value="weekly">ë§¤ì£¼</option>
        <option value="monthly">ë§¤ì›”</option>
      </select>
      <button id="addBtn" class="btn">ì¶”ê°€</button>
    </div>

    <ul id="taskList"></ul>

    <div class="input-row" style="margin-top:8px">
      <button id="clearDone" class="btn-outline">ì™„ë£Œ ëª¨ë‘ ì§€ìš°ê¸°</button>
      <button id="exportBtn" class="btn-outline">ë‚´ë³´ë‚´ê¸°(JSON)</button>
      <input type="file" id="importFile" accept="application/json" />
      <button id="aiBtn" class="btn-outline">ğŸ¤– ìš”ì•½/ë™ê¸°ë¶€ì—¬</button>
    </div>

    <div style="margin-top:12px;display:flex;gap:16px;align-items:center;flex-wrap:wrap">
      <div class="ring-wrap"><div id="ring" class="ring" data-label="0%"></div></div>
      <div id="summary" class="muted">í•  ì¼ì„ ì¶”ê°€í•´ë³´ì„¸ìš”.</div>
    </div>
  </div>

  <!-- ì£¼ê°„ ê³„íš -->
  <div class="card">
    <div class="header-row">
      <h2>ğŸ—“ ì£¼ê°„ ê³„íš</h2>
      <div class="muted" id="weekTitle"></div>
    </div>
    <div class="h-scroll"><div id="weekGrid" class="week"></div></div>
  </div>

  <!-- ì›”ê°„ ë‹¬ë ¥ + í†µê³„ -->
  <div class="card">
    <h2>ğŸ“† ì›”ê°„ ë‹¬ë ¥ & ğŸ“Š í†µê³„</h2>
    <div class="h-scroll"><div id="calendar" class="calendar" style="margin-bottom:12px"></div></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <canvas id="chartWeek" height="140"></canvas>
      <canvas id="chartMonth" height="140"></canvas>
    </div>
  </div>
</div>

<!-- ì„¤ì • ëª¨ë‹¬(Drive/AI/API í‚¤) -->
<div id="settingsModal" class="modal">
  <div class="panel">
    <div class="header-row">
      <h3>âš™ï¸ ì„¤ì •</h3>
      <button id="closeSettings" class="btn-outline icon-btn">ë‹«ê¸°</button>
    </div>
    <div style="display:grid;gap:12px;margin-top:8px">
      <div class="card" style="margin:0">
        <h4>â˜ï¸ Google Drive ë°±ì—…(ì„ íƒ)</h4>
        <div class="muted">* ì™„ì „ í´ë¼ì´ì–¸íŠ¸ ë°©ì‹. ì•„ë˜ ì •ë³´ê°€ ë¹„ì–´ ìˆìœ¼ë©´ ë²„íŠ¼ì´ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.</div>
        <div class="input-row" style="margin-top:8px">
          <input id="gapiKey" placeholder="Google API Key" />
          <input id="gclientId" placeholder="Google OAuth Client ID" />
        </div>
        <div class="input-row">
          <button id="gLogin" class="btn-outline">Google ë¡œê·¸ì¸</button>
          <button id="gBackup" class="btn-outline" disabled>Driveì— ë°±ì—…</button>
          <button id="gRestore" class="btn-outline" disabled>Driveì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        </div>
        <div class="muted" id="gStatus">ìƒíƒœ: ë¯¸ì„¤ì •</div>
      </div>

      <div class="card" style="margin:0">
        <h4>ğŸ¤– AI ìš”ì•½/ë™ê¸°ë¶€ì—¬ (ì„ íƒ)</h4>
        <div class="muted">OpenAI API Keyë¥¼ ì €ì¥í•˜ë©´ ë¸Œë¼ìš°ì €ì—ì„œ ì§ì ‘ í˜¸ì¶œí•©ë‹ˆë‹¤(ì„œë²„ ì—†ìŒ).</div>
        <div class="input-row" style="margin-top:8px">
          <input id="openaiKey" placeholder="OpenAI API Key (sk-...)" />
          <button id="saveOpenAI" class="btn">ì €ì¥</button>
          <button id="clearOpenAI" class="btn-outline">ì‚­ì œ</button>
        </div>
        <div class="muted">ì €ì¥ëœ í‚¤ëŠ” ì´ ë¸Œë¼ìš°ì €ì˜ LocalStorageì—ë§Œ ë³´ê´€ë©ë‹ˆë‹¤.</div>
      </div>
    </div>
  </div>
</div>

<script>
/* ========== ê³µí†µ ìœ í‹¸/ìƒíƒœ ========== */
const $=s=>document.querySelector(s);
const fmt=d=>d.toISOString().slice(0,10);
const KEY=ymd=>"plan."+ymd;
const THEMES=['theme-default','theme-mint','theme-lavender','theme-sunset'];
const tagify=t=> (t.match(/#\S+/g)||[]);
function esc(s=''){return s.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}

/* ========== ê°„ë‹¨ ë©”ëª¨ ========== */
$("#simpleAddBtn").onclick=()=>{const i=$("#simpleTaskInput"); if(!i.value.trim())return; const li=document.createElement('li'); li.textContent=i.value.trim(); li.onclick=()=>li.classList.toggle('completed'); $("#simpleTaskList").appendChild(li); i.value=''; i.focus();};

/* ========== ë°ì´í„° IO ========== */
function load(date){return JSON.parse(localStorage.getItem(KEY(fmt(date)))||'[]')}
function save(date,arr){localStorage.setItem(KEY(fmt(date)),JSON.stringify(arr))}

/* ========== ì˜¤ëŠ˜ì˜ ëª©í‘œ ë Œë” ========== */
const taskList=$("#taskList"), ring=$("#ring"), summary=$("#summary"), tagFilter=$("#tagFilter");
function render(date){
  let arr=load(date);
  // íƒœê·¸ í•„í„°
  const f=tagFilter.value;
  if(f){arr=arr.filter(t=>(t.tags||[]).includes(f))}
  // â­ ìš°ì„ , ì™„ë£Œ í•˜ë‹¨
  arr.sort((a,b)=> (b.star?1:0)-(a.star?1:0) || (a.done?1:0)-(b.done?1:0));
  taskList.innerHTML='';
  // íƒœê·¸ ëª©ë¡ ì—…ë°ì´íŠ¸
  const all=Array.from(new Set(load(date).flatMap(t=>t.tags||[]))).sort();
  tagFilter.innerHTML='<option value="">íƒœê·¸ í•„í„°: ì „ì²´</option>'+all.map(t=>`<option value="${t}">${t}</option>`).join('');
  arr.forEach((t,i)=>{
    const li=document.createElement('li'); li.className='task'+(t.done?' completed':'');
    const tags=(t.tags||[]).map(x=>`<span class="badge">${esc(x)}</span>`).join(' ');
    li.innerHTML=`<div class="text">${esc(t.text)}</div>
      <div class="meta">${t.repeat? 'ğŸ” '+t.repeat:''} ${tags}
        <span class="star ${t.star?'active':''}" title="ì¤‘ìš”">â˜…</span>
        <button class="btn-outline icon-btn" title="ì‚­ì œ">ì‚­ì œ</button>
      </div>`;
    li.querySelector('.text').onclick=()=>{const a=load(date); a[i].done=!a[i].done; save(date,a); render(date); updateStats(date);};
    li.querySelector('.star').onclick=()=>{const a=load(date); a[i].star=!a[i].star; save(date,a); render(date);};
    li.querySelector('button').onclick=()=>{const a=load(date); a.splice(i,1); save(date,a); render(date); updateStats(date);};
    taskList.appendChild(li);
  });
}
/* ì™„ë£Œìœ¨ */
function updateStats(date){
  const arr=load(date), done=arr.filter(t=>t.done).length, total=arr.length;
  const pct= total? Math.round(done/total*100):0;
  ring.style.setProperty('--p',pct); ring.setAttribute('data-label',pct+'%');
  summary.textContent = total? `ì´ ${total}ê°œ ì¤‘ ${done}ê°œ ì™„ë£Œ`:'í•  ì¼ì„ ì¶”ê°€í•´ë³´ì„¸ìš”.';
}

/* ========== ì¶”ê°€/ë°˜ë³µ/ìë™ ì´ì›” ========== */
const datePick=$("#datePick"), repeatSel=$("#repeatSel"), taskInput=$("#taskInput");
function addTask(date,text,repeat){
  const arr=load(date); arr.push({text,done:false,repeat,tags:tagify(text),star:false}); save(date,arr); render(date); updateStats(date);
}
$("#addBtn").onclick=()=>{const t=taskInput.value.trim(); if(!t)return; const d=new Date(datePick.value); addTask(d,t,repeatSel.value); applyRepeatsFrom(d); taskInput.value=''; taskInput.focus();};
$("#taskInput").addEventListener('keydown',e=>{if(e.key==='Enter') $("#addBtn").click();});

/* ë°˜ë³µ ìƒì„±: ê¸°ì¤€ì¼ë¶€í„° ì• 30ì¼ ìƒì„± */
function applyRepeatsFrom(date){
  const base=load(date); const today=new Date(date);
  for(let i=1;i<=30;i++){
    const d=new Date(today); d.setDate(today.getDate()+i);
    const next=load(d);
    base.filter(t=>t.repeat).forEach(t=>{
      let doit=false;
      if(t.repeat==='daily') doit=true;
      if(t.repeat==='weekly' && d.getDay()===today.getDay()) doit=true;
      if(t.repeat==='monthly' && d.getDate()===today.getDate()) doit=true;
      if(doit && !next.some(x=>x.text===t.text && x.repeat===t.repeat)){ next.push({...t,done:false}); save(d,next); }
    });
  }
}

/* ìë™ ì´ì›”: ì–´ì œ ë¯¸ì™„ë£Œ â†’ ì˜¤ëŠ˜ë¡œ ì´ë™ */
function rollover(){
  const today=new Date(); today.setHours(0,0,0,0);
  const yesterday=new Date(today); yesterday.setDate(today.getDate()-1);
  const y=load(yesterday), t=load(today);
  const carry=y.filter(it=>!it.done);
  if(carry.length){
    const merged=[...t];
    carry.forEach(c=>{ if(!merged.some(x=>x.text===c.text)) merged.push({...c,done:false});});
    save(today,merged);
  }
}

/* ========== ì£¼ê°„ ê³„íš ========== */
const weekGrid=$("#weekGrid"), weekTitle=$("#weekTitle");
function mondayOf(date){const d=new Date(date); const day=(d.getDay()+6)%7; d.setDate(d.getDate()-day); d.setHours(0,0,0,0); return d;}
function endOfWeek(mon){const d=new Date(mon); d.setDate(d.getDate()+6); return d;}
function lw(mon){return JSON.parse(localStorage.getItem('week.'+fmt(mon))||'{}')}
function sw(mon,obj){localStorage.setItem('week.'+fmt(mon), JSON.stringify(obj))}
function renderWeek(date){
  const mon=mondayOf(date), sun=endOfWeek(mon), data=Object.assign({0:'',1:'',2:'',3:'',4:'',5:'',6:''}, lw(mon));
  weekTitle.textContent=`${fmt(mon)} (ì›”) ~ ${fmt(sun)} (ì¼)`;
  weekGrid.innerHTML='';
  'ì›”í™”ìˆ˜ëª©ê¸ˆí† ì¼'.split('').forEach((name,i)=>{
    const box=document.createElement('div'); box.className='day';
    box.innerHTML=`<strong>${name}</strong><textarea placeholder="${name} ê³„íš">${esc(data[i])}</textarea>`;
    const ta=box.querySelector('textarea'); let t; ta.oninput=e=>{clearTimeout(t); t=setTimeout(()=>{const cur=lw(mon); cur[i]=e.target.value; sw(mon,cur)},300);}
    weekGrid.appendChild(box);
  });
}

/* ========== ë‹¬ë ¥ ========== */
const calendar=$("#calendar");
function renderCalendar(date){
  calendar.innerHTML=''; const y=date.getFullYear(), m=date.getMonth();
  const first=new Date(y,m,1); let start=new Date(first); start.setDate(first.getDate()-((first.getDay()+6)%7));
  for(let i=0;i<42;i++){
    const d=new Date(start); d.setDate(start.getDate()+i);
    const cell=document.createElement('div'); cell.className='cell'; if(fmt(d)===fmt(new Date())) cell.classList.add('today');
    const preview=(load(d)||[]).slice(0,2).map(t=>esc(t.text)).join('<br>');
    cell.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center">
      <strong>${d.getDate()}</strong><button class="btn-outline icon-btn">ë³´ê¸°</button></div>
      <div class="muted" style="margin-top:6px;font-size:12px">${preview}</div>`;
    cell.querySelector('button').onclick=()=>{datePick.value=fmt(d); render(d); updateStats(d); renderWeek(d);}
    calendar.appendChild(cell);
  }
}

/* ========== í†µê³„ (Chart.js) ========== */
let chartWeek, chartMonth;
function statsWeek(date){
  const mon=mondayOf(date); const days=[...Array(7)].map((_,i)=>{const d=new Date(mon); d.setDate(mon.getDate()+i); const arr=load(d); return arr.length? Math.round(arr.filter(t=>t.done).length/arr.length*100):0;});
  if(chartWeek) chartWeek.destroy();
  chartWeek=new Chart($("#chartWeek"), {type:'line', data:{labels:['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† ','ì¼'], datasets:[{label:'ì£¼ê°„ ì™„ë£Œìœ¨(%)', data:days, tension:.3}]}, options:{scales:{y:{min:0,max:100}}}});
}
function statsMonth(date){
  const y=date.getFullYear(), m=date.getMonth(), last=new Date(y,m+1,0).getDate();
  const arr=[...Array(last)].map((_,day)=>{const d=new Date(y,m,day+1); const a=load(d); return a.length? Math.round(a.filter(t=>t.done).length/a.length*100):0;});
  if(chartMonth) chartMonth.destroy();
  chartMonth=new Chart($("#chartMonth"), {type:'bar', data:{labels:arr.map((_,i)=>i+1), datasets:[{label:'ì›”ê°„ ì™„ë£Œìœ¨(%)', data:arr}]}, options:{scales:{y:{min:0,max:100}}}});
}

/* ========== ì•Œë¦¼ ìŠ¤ì¼€ì¤„ëŸ¬ ========== */
function ensureNotif(){ if('Notification' in window && Notification.permission==='default') Notification.requestPermission(); }
function scheduleDaily(){
  const t=localStorage.getItem('planner.notifyAt'); if(!t) return;
  ensureNotif();
  // ê°„ë‹¨ ì‹œê°„ ìŠ¤ì¼€ì¤„: í˜ì´ì§€ ì—´ë ¤ ìˆëŠ” ë™ì•ˆ setTimeoutìœ¼ë¡œ ë‹¤ìŒ ì•Œë¦¼ ì˜ˆì•½
  const [hh,mm]=t.split(':').map(Number);
  const now=new Date(), next=new Date(); next.setHours(hh,mm,0,0); if(next<=now) next.setDate(next.getDate()+1);
  const ms=next-now;
  setTimeout(()=>{ const today=new Date($("#datePick").value); const arr=load(today); const remain=arr.filter(x=>!x.done).map(x=>'â€¢ '+x.text).slice(0,5).join('\n')||'ì˜¤ëŠ˜ í•  ì¼ì´ ì—†ì–´ìš”!'; if('Notification' in window && Notification.permission==='granted'){ new Notification('ì˜¤ëŠ˜ì˜ ê³„íš', { body: remain }); } scheduleDaily(); }, ms);
}
$("#notifySave").onclick=()=>{ const v=$("#dailyNotifyAt").value; localStorage.setItem('planner.notifyAt', v||''); alert(v?'ì•Œë¦¼ ì‹œê° ì €ì¥ë¨':'ì•Œë¦¼ í•´ì œë¨'); scheduleDaily(); };

/* ========== íŒŒì¼ ë‚´ë³´ë‚´ê¸°/ë¶ˆëŸ¬ì˜¤ê¸°/ì™„ë£Œ ì •ë¦¬ ========== */
$("#clearDone").onclick=()=>{ const d=new Date(datePick.value); save(d, load(d).filter(t=>!t.done)); render(d); updateStats(d); };
$("#exportBtn").onclick=()=>{ const d=new Date(datePick.value); const blob=new Blob([JSON.stringify(load(d),null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`plan_${fmt(d)}.json`; a.click(); };
$("#importFile").onchange=e=>{ const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const d=new Date(datePick.value); save(d, JSON.parse(r.result)); render(d); updateStats(d);}catch{alert('JSON í˜•ì‹ ì˜¤ë¥˜');} }; r.readAsText(f,'utf-8'); };

/* ========== í…Œë§ˆ ========== */
const themeSel=$("#themeSel"); themeSel.value=localStorage.getItem('planner.theme')||'theme-default'; document.body.className=themeSel.value;
themeSel.onchange=()=>{ document.body.className=themeSel.value; localStorage.setItem('planner.theme', themeSel.value); };

/* ========== AI ìš”ì•½/ë™ê¸°ë¶€ì—¬(ì„ íƒ) ========== */
const OPENAI_KEY_KEY='planner.openai.key';
$("#saveOpenAI")?.addEventListener('click',()=>{localStorage.setItem(OPENAI_KEY_KEY, $("#openaiKey").value.trim()); alert('ì €ì¥í–ˆìŠµë‹ˆë‹¤');});
$("#clearOpenAI")?.addEventListener('click',()=>{localStorage.removeItem(OPENAI_KEY_KEY); $("#openaiKey").value=''; alert('ì‚­ì œí–ˆìŠµë‹ˆë‹¤');});
$("#aiBtn").onclick=async ()=>{
  const key=localStorage.getItem(OPENAI_KEY_KEY);
  const d=new Date(datePick.value); const arr=load(d);
  const text = arr.length? arr.map((t,i)=>`${i+1}. ${t.text}${t.done?' (ì™„ë£Œ)':''}`).join('\n') : 'í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤.';
  if(!key){ // í‚¤ ì—†ìœ¼ë©´ ë¡œì»¬ ëª¨ë“œ(ê°„ë‹¨ ë¬¸êµ¬)
    const left = arr.filter(x=>!x.done).length;
    alert(left? `ğŸ”¥ ì˜¤ëŠ˜ ${left}ê°œ ë‚¨ì•˜ì–´! ê°€ì¥ ì‘ì€ ê²ƒë¶€í„° ë°”ë¡œ í•˜ë‚˜ ëë‚´ì.` : 'ğŸ‰ ì „ë¶€ ì™„ë£Œ! ê°€ë³ê²Œ ìŠ¤íŠ¸ë ˆì¹­ í•˜ì!');
    return;
  }
  try{
    // OpenAI Chat Completions (gpt-4o-mini ë“±) â€” í‚¤ê°€ ìˆì„ ë•Œë§Œ ì‹¤í–‰
    const res=await fetch('https://api.openai.com/v1/chat/completions',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+key},
      body:JSON.stringify({
        model:'gpt-4o-mini',
        messages:[
          {role:'system',content:'ë„ˆëŠ” í•œêµ­ì–´ ì½”ì¹˜ì•¼. ì˜¤ëŠ˜ì˜ í•  ì¼ì„ ê°„ë‹¨íˆ ìš”ì•½í•˜ê³  1~2ì¤„ ë™ê¸°ë¶€ì—¬ë¥¼ ì¤€ë‹¤.'},
          {role:'user',content:`ì˜¤ëŠ˜ì˜ ê³„íš:\n${text}\nìš”ì•½ê³¼ ë™ê¸°ë¶€ì—¬ë¥¼ ë¶€íƒí•´.`}
        ],
        temperature:0.7
      })
    });
    const data=await res.json();
    const msg=data.choices?.[0]?.message?.content || 'ìš”ì•½ì„ ìƒì„±í•˜ì§€ ëª»í–ˆì–´ìš”.';
    alert(msg);
  }catch(err){ console.error(err); alert('ìš”ì•½ í˜¸ì¶œ ì‹¤íŒ¨(í‚¤/ë„¤íŠ¸ì›Œí¬ í™•ì¸)'); }
};

/* ========== ì„¤ì • ëª¨ë‹¬ + Drive(ì˜µì…˜) ========== */
const modal=$("#settingsModal"), settingsBtn=$("#settingsBtn"), closeSettings=$("#closeSettings");
settingsBtn.onclick=()=>{ $("#openaiKey").value=localStorage.getItem(OPENAI_KEY_KEY)||''; modal.classList.add('open'); renderDriveStatus(); };
closeSettings.onclick=()=>modal.classList.remove('open');

/* Google Drive: ì™„ì „ ì˜µì…˜. í‚¤/í´ë¼ID ì—†ìœ¼ë©´ ë¹„í™œì„±í™” ìƒíƒœ. */
const GAPI_KEY_KEY='planner.gapi.key', GCLIENT_ID_KEY='planner.gapi.client';
const gStatus=$("#gStatus"), gapiKey=$("#gapiKey"), gclientId=$("#gclientId"), gLogin=$("#gLogin"), gBackup=$("#gBackup"), gRestore=$("#gRestore");
function renderDriveStatus(){
  gapiKey.value=localStorage.getItem(GAPI_KEY_KEY)||''; gclientId.value=localStorage.getItem(GCLIENT_ID_KEY)||'';
  const ready=!!(gapiKey.value && gclientId.value);
  gLogin.disabled=gBackup.disabled=gRestore.disabled=!ready;
  gStatus.textContent='ìƒíƒœ: '+(ready?'ì„¤ì •ë¨(ë¡œê·¸ì¸ í•„ìš”)':'ë¯¸ì„¤ì •');
}
[gapiKey,gclientId].forEach(el=>el.addEventListener('change',()=>{localStorage.setItem(el===gapiKey?GAPI_KEY_KEY:GCLIENT_ID_KEY, el.value.trim()); renderDriveStatus();}));

// gapi ìŠ¤í‚µ: ë²„íŠ¼ ëˆ„ë¥´ë©´ ê°€ì´ë“œ í‘œì‹œ(í‚¤ ë„£ìœ¼ë©´ êµ¬í˜„ ê°€ëŠ¥)
gLogin.onclick=()=>alert('Google DriveëŠ” í´ë¼ì´ì–¸íŠ¸ í‚¤/í´ë¼ì´ì–¸íŠ¸IDê°€ í•„ìš”í•©ë‹ˆë‹¤.\nì„¤ì • ì €ì¥ í›„ ì´ ë²„íŠ¼ì„ ë‹¤ì‹œ ëˆŒëŸ¬ ë¡œê·¸ì¸ íë¦„ì„ êµ¬í˜„í•˜ì„¸ìš”.\n(ì—¬ê¸°ì„œëŠ” ì•ˆì „/ë‹¨ìˆœí™”ë¥¼ ìœ„í•´ ê¸°ë³¸ ê°€ì´ë“œë§Œ ì œê³µí•©ë‹ˆë‹¤)');
gBackup.onclick=()=>alert('í˜„ì¬ëŠ” JSON ë‚´ë³´ë‚´ê¸°(ë‹¤ìš´ë¡œë“œ)ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.\nDrive ì—°ê²°ì„ ì›í•˜ë©´ Google API í‚¤/í´ë¼IDë¡œ gapië¥¼ ì´ˆê¸°í™”í•´ ì—…ë¡œë“œí•˜ì„¸ìš”.');
gRestore.onclick=()=>alert('Drive ë¶ˆëŸ¬ì˜¤ê¸°ë„ ë™ì¼í•©ë‹ˆë‹¤. (ë˜ëŠ” JSON ë¶ˆëŸ¬ì˜¤ê¸° ì‚¬ìš©)');

/* ========== PWA ì„¤ì¹˜ & SW ë“±ë¡ ========== */
let deferredPrompt=null;
window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();deferredPrompt=e;$("#installBtn").style.display='inline-block';});
$("#installBtn").onclick=async()=>{if(!deferredPrompt)return;deferredPrompt.prompt();await deferredPrompt.userChoice;deferredPrompt=null;$("#installBtn").style.display='none';};
if('serviceWorker' in navigator){window.addEventListener('load',()=>navigator.serviceWorker.register('./service-worker.js',{scope:'./'}).catch(console.error));}

/* ========== ë‚ ì§œ ì „í™˜/ì´ˆê¸°í™” ========== */
function goToday(){const t=new Date();t.setHours(0,0,0,0);datePick.value=fmt(t);render(t);updateStats(t);renderWeek(t);renderCalendar(t);statsWeek(t);statsMonth(t);}
$("#todayBtn").onclick=goToday;
datePick.onchange=()=>{const d=new Date(datePick.value);render(d);updateStats(d);renderWeek(d);renderCalendar(d);statsWeek(d);statsMonth(d);}
tagFilter.onchange=()=>{const d=new Date(datePick.value);render(d);}

/* ========== ë¶€íŒ… ========== */
(function init(){
  // ì•Œë¦¼ ì‹œê° UI ì„¸íŒ…
  $("#dailyNotifyAt").value = localStorage.getItem('planner.notifyAt') || '';
  // í…Œë§ˆ ì ìš©ì€ ìœ„ì—ì„œ ì²˜ë¦¬ë¨
  // ìë™ ì´ì›” í›„ ì˜¤ëŠ˜ ë¡œë“œ
  rollover();
  goToday();
  // ì•Œë¦¼ ìŠ¤ì¼€ì¤„ëŸ¬ ê°€ë™
  scheduleDaily();
})();
</script>
</body>
</html>
