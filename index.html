<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>닮은꼴 + 만화필터</title>
<style>
  body {margin:0;background:#0b1220;color:#e7ecff;font-family:"Noto Sans KR",sans-serif;text-align:center;}
  .container{max-width:900px;margin:30px auto;padding:0 16px;}
  h1{font-size:24px;margin-bottom:8px;}
  .card{background:#121a2b;border-radius:12px;padding:16px;margin:18px 0;border:1px solid #1f2a44;}
  .btn{background:#6aa2ff;color:#0b1220;padding:8px 12px;border:none;border-radius:8px;font-weight:bold;cursor:pointer;}
  input[type=file]{display:none;}
  canvas{max-width:100%;border-radius:8px;margin-top:10px;}
  .small{font-size:13px;color:#9fb0ff;}
  #cartoonCanvas{margin-top:12px;border:1px solid #1f2a44;}
</style>
</head>
<body>
<div class="container">
  <h1>📸 닮은꼴 + 만화필터</h1>
  <p class="small">사진을 업로드하면 사물·동물 라벨과 얼굴 인식 후, 만화풍으로 변환합니다 🎨</p>

  <div class="card">
    <label class="btn">
      <input id="fileInput" type="file" accept="image/*"> 사진 업로드
    </label>
    <span id="status" class="small">모델 로딩중...</span><br>
    <canvas id="canvas"></canvas>
    <canvas id="cartoonCanvas"></canvas>
    <div id="labels" class="small"></div>
    <div id="matches" class="small" style="margin-top:8px;"></div>
  </div>
</div>

<!-- JS 라이브러리 -->
<script src="https://unpkg.com/@tensorflow/tfjs@4.20.0"></script>
<script src="https://unpkg.com/@tensorflow-models/mobilenet@2.1.0"></script>
<script src="https://unpkg.com/@tensorflow-models/body-pix@2.2.0"></script>
<script defer src="https://unpkg.com/face-api.js@0.22.2/dist/face-api.min.js"></script>

<script>
let mobilenetModel=null;
let bodypixModel=null;
const fileInput=document.getElementById('fileInput');
const canvas=document.getElementById('canvas');
const cartoonCanvas=document.getElementById('cartoonCanvas');
const ctx=canvas.getContext('2d');
const cctx=cartoonCanvas.getContext('2d');
const statusEl=document.getElementById('status');
const labelsEl=document.getElementById('labels');
const matchesEl=document.getElementById('matches');

async function loadModels(){
  statusEl.textContent='모델 로딩중...';
  mobilenetModel = await mobilenet.load();
  bodypixModel = await bodyPix.load();
  await faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/weights');
  await faceapi.nets.faceLandmark68Net.loadFromUri('https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/weights');
  await faceapi.nets.faceRecognitionNet.loadFromUri('https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/weights');
  statusEl.textContent='모델 로딩 완료 ✅';
}
loadModels();

fileInput.addEventListener('change', e=>{
  const file=e.target.files[0];
  if(!file)return;
  const img=new Image();
  img.onload=()=>handleImage(img);
  img.src=URL.createObjectURL(file);
});

async function handleImage(img){
  const max=500;
  const r=Math.min(max/img.width,max/img.height,1);
  canvas.width=img.width*r; canvas.height=img.height*r;
  ctx.drawImage(img,0,0,canvas.width,canvas.height);

  // 1️⃣ 사물/동물 인식
  const preds=await mobilenetModel.classify(canvas);
  labelsEl.innerHTML='<b>사물/동물 라벨:</b><br>'+preds.map(p=>`${p.className} (${(p.probability*100).toFixed(1)}%)`).join('<br>');

  // 2️⃣ 얼굴 인식
  const det=await faceapi.detectSingleFace(canvas,new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
  matchesEl.textContent = det ? '얼굴 인식 성공 ✅' : '얼굴을 찾지 못했습니다.';

  // 3️⃣ 만화 필터 변환
  cartoonCanvas.width = canvas.width;
  cartoonCanvas.height = canvas.height;
  const segmentation = await bodypixModel.segmentPerson(canvas);
  const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  const data = imageData.data;
  for(let i=0;i<data.length;i+=4){
    const mask = segmentation.data[i/4];
    if(mask===1){ // 인물 부분: 색상 강조
      data[i] = Math.min(255, data[i]*1.2);
      data[i+1] = Math.min(255, data[i+1]*1.2);
      data[i+2] = Math.min(255, data[i+2]*1.2);
    } else { // 배경 부분: 흐림 + 회색톤
      const avg = (data[i]+data[i+1]+data[i+2])/3;
      data[i]=data[i+1]=data[i+2]=avg*0.6;
    }
  }
  cctx.putImageData(imageData, 0, 0);
}
</script>
</body>
</html>
