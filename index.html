<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ë‹®ì€ê¼´ ì°¾ê¸° (ì—°ì˜ˆì¸/ë™ë¬¼/ì‚¬ë¬¼)</title>
<style>
  :root { --bg:#0b1220; --card:#121a2b; --text:#e7ecff; --muted:#9fb0ff; --accent:#6aa2ff;}
  body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,AppleSDGothicNeo,"Noto Sans KR",Segoe UI,Roboto}
  header{padding:18px 16px;border-bottom:1px solid #1f2a44}
  h1{font-size:18px;margin:0} .muted{color:var(--muted);font-size:13px}
  main{max-width:960px;margin:24px auto;padding:0 16px;display:grid;gap:16px}
  .card{background:var(--card);border:1px solid #1f2a44;border-radius:14px;padding:14px}
  .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
  input[type=file]{display:none}
  .btn,.chip{background:#192648;border:1px solid #243357;color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer;font-size:14px}
  .btn.primary{background:var(--accent);border-color:#5b91ea;color:#0b1220;font-weight:700}
  .btn:disabled{opacity:.55;cursor:not-allowed}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
  .thumb{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:10px;border:1px solid #1f2a44}
  .row>label{display:inline-flex;gap:8px;align-items:center}
  progress{width:180px;height:10px}
  .kvs{font-size:14px;line-height:1.6}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#243357;margin:2px 4px 0 0}
  .small{font-size:12px;color:var(--muted)}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace}
  .right{margin-left:auto}
</style>
</head>
<body>
<header>
  <h1>ğŸ“· ë‹®ì€ê¼´ ì°¾ê¸°</h1>
  <div class="muted">ì‚¬ì§„ì„ ì˜¬ë¦¬ë©´ <b>ë™ë¬¼/ì‚¬ë¬¼ ë¼ë²¨</b>ì„ ìë™ ë¶„ì„í•˜ê³ , ì¶”ê°€í•œ <b>ì‚¬ëŒ ê°¤ëŸ¬ë¦¬</b>ì—ì„œ ë‹®ì€ê¼´ì„ ì°¾ì•„ì¤˜ìš”.</div>
</header>

<main>
  <!-- ì—…ë¡œë“œ/ëª¨ë¸ ìƒíƒœ -->
  <section class="card">
    <div class="row">
      <label class="btn">
        <input id="fileInput" type="file" accept="image/*"/>
        ì‚¬ì§„ ì—…ë¡œë“œ
      </label>
      <button id="demoBtn" class="chip">ìƒ˜í”Œë¡œ í…ŒìŠ¤íŠ¸</button>
      <div class="right small">ëª¨ë¸ ë¡œë”© ìƒíƒœ: <span id="modelStatus">ëŒ€ê¸°ì¤‘</span></div>
    </div>
    <div class="row" style="margin-top:8px">
      <progress id="prog" max="100" value="0"></progress>
      <span id="progText" class="small"></span>
    </div>
  </section>

  <!-- ê²°ê³¼ -->
  <section class="grid">
    <div class="card">
      <h3 style="margin-top:2px">ğŸ” ë¶„ì„ ê²°ê³¼</h3>
      <canvas id="canvas" class="thumb" style="max-width:100%;height:auto"></canvas>
      <div id="labels" class="kvs" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <h3 style="margin-top:2px">ğŸ‘¤ ë‹®ì€ ì‚¬ëŒ(ë¡œì»¬ ê°¤ëŸ¬ë¦¬)</h3>
      <div id="faceStatus" class="small">ê°¤ëŸ¬ë¦¬ ì¸ì›: <span id="galleryCount">0</span>ëª…</div>
      <div id="matches" class="kvs" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- ê°¤ëŸ¬ë¦¬ ê´€ë¦¬ -->
  <section class="card">
    <div class="row">
      <h3 style="margin:0">ğŸ—‚ ë‚´ ê°¤ëŸ¬ë¦¬ ì¶”ê°€/ê´€ë¦¬</h3>
      <button id="clearGallery" class="btn" title="ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì´ˆê¸°í™”">ëª¨ë‘ ì§€ìš°ê¸°</button>
    </div>
    <div class="row" style="margin-top:8px">
      <input id="nameInput" placeholder="ì´ë¦„ (ì˜ˆ: ì•„ì´ìœ , RM, ë§ˆë™ì„)" class="chip" style="flex:1;min-width:220px"/>
      <label class="btn">
        <input id="refInput" type="file" accept="image/*"/>
        ì‚¬ëŒ ì‚¬ì§„ ì¶”ê°€
      </label>
      <span class="small">ì¶”ê°€ ì¦‰ì‹œ ì–¼êµ´ ì„ë² ë”©ì„ ê³„ì‚°í•´ ì €ì¥í•©ë‹ˆë‹¤.</span>
    </div>
    <div id="gallery" class="grid" style="margin-top:12px"></div>
  </section>

  <section class="card small">
    <b>TIP</b>
    <ul>
      <li>ì‚¬ëŒ ë§¤ì¹­ì€ <span class="mono">face-api.js</span> ì„ë² ë”©(128D)ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. ì •í™•ë„ë¥¼ ë†’ì´ë ¤ë©´ ë ˆí¼ëŸ°ìŠ¤ ì‚¬ì§„ì„ <b>ì •ë©´, ë‹¨ì¼ ì¸ë¬¼</b>ë¡œ ì¶”ê°€í•˜ì„¸ìš”.</li>
      <li>ë™ë¬¼/ì‚¬ë¬¼ ë¼ë²¨ì€ <span class="mono">TensorFlow.js MobileNet</span>ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. ìƒìœ„ 3ê°œ ë¼ë²¨ê³¼ ì‹ ë¢°ë„ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.</li>
      <li>ëª¨ë“  ë°ì´í„°(ê°¤ëŸ¬ë¦¬ ì„ë² ë”©)ëŠ” <b>ë¡œì»¬ìŠ¤í† ë¦¬ì§€</b>ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤.</li>
    </ul>
  </section>
</main>

<!-- ë¼ì´ë¸ŒëŸ¬ë¦¬ (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0"></script>
<script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

<script>
/* ======= ì „ì—­ ======= */
let mobilenetModel = null;
const qs = (s)=>document.querySelector(s);
const canvas = qs('#canvas'), ctx = canvas.getContext('2d');
const modelStatus = qs('#modelStatus'); const prog = qs('#prog'); const progText = qs('#progText');
const galleryEl = qs('#gallery'); const galleryCountEl = qs('#galleryCount');
const labelsEl = qs('#labels'); const matchesEl = qs('#matches');

/* ======= ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ìœ í‹¸ ======= */
const LS_KEY = 'lookalike.gallery.v1'; // [{name, descriptor(Float32[128] as array), thumbDataUrl}]
function loadGallery(){ try { return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); } catch { return []; } }
function saveGallery(arr){ localStorage.setItem(LS_KEY, JSON.stringify(arr)); renderGallery(); }

/* ======= ëª¨ë¸ ë¡œë”© ======= */
async function loadModels(){
  modelStatus.textContent = 'ëª¨ë¸ ë¡œë”©ì¤‘â€¦';
  prog.value = 10; progText.textContent = 'TensorFlow / MobileNet';
  mobilenetModel = await mobilenet.load({version:2, alpha:1.0});
  prog.value = 55; progText.textContent = 'face-api (tiny face, landmarks, recognition)';
  const url = 'https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/weights';
  await Promise.all([
    faceapi.nets.tinyFaceDetector.loadFromUri(url),
    faceapi.nets.faceLandmark68Net.loadFromUri(url),
    faceapi.nets.faceRecognitionNet.loadFromUri(url),
  ]);
  prog.value = 100; progText.textContent = 'ì™„ë£Œ';
  modelStatus.textContent = 'ë¡œë”© ì™„ë£Œ';
}
loadModels().catch(e=>{ modelStatus.textContent='ë¡œë”© ì‹¤íŒ¨'; console.error(e); });

/* ======= ì´ë¯¸ì§€ í‘œì‹œ ======= */
function drawToCanvas(img){
  const max = 800, r = Math.min(max/img.width, max/img.height, 1);
  canvas.width = Math.round(img.width*r); canvas.height = Math.round(img.height*r);
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(img, 0,0, canvas.width, canvas.height);
}

/* ======= ë¼ë²¨ë§ (ì‚¬ë¬¼/ë™ë¬¼) ======= */
async function classifyImage(){
  if(!mobilenetModel) return;
  const preds = await mobilenetModel.classify(canvas);
  labelsEl.innerHTML = '<b>ì‚¬ë¬¼/ë™ë¬¼ ë¼ë²¨ (Top-3)</b><br>' + preds.map(p=>(
    `<span class="pill">${p.className} â€” ${(p.probability*100).toFixed(1)}%</span>`
  )).join(' ');
}

/* ======= ì–¼êµ´ ì„ë² ë”© ê³„ì‚° ======= */
async function getFaceDescriptorFromCanvas(){
  const detOpt = new faceapi.TinyFaceDetectorOptions({inputSize:416, scoreThreshold:0.5});
  const det = await faceapi.detectSingleFace(canvas, detOpt).withFaceLandmarks().withFaceDescriptor();
  return det?.descriptor || null;
}
async function descriptorFromImageElement(imgEl){
  const detOpt = new faceapi.TinyFaceDetectorOptions({inputSize:416, scoreThreshold:0.5});
  const det = await faceapi.detectSingleFace(imgEl, detOpt).withFaceLandmarks().withFaceDescriptor();
  return det?.descriptor || null;
}

/* ======= ìœ ì‚¬ë„ ê³„ì‚° (ì½”ì‚¬ì¸ ìœ ì‚¬ë„) ======= */
function cosineSim(a,b){
  let dot=0, na=0, nb=0;
  for(let i=0;i<a.length;i++){ dot+=a[i]*b[i]; na+=a[i]*a[i]; nb+=b[i]*b[i]; }
  return dot/(Math.sqrt(na)*Math.sqrt(nb)+1e-8);
}

/* ======= ê°¤ëŸ¬ë¦¬ ë Œë” ======= */
function renderGallery(){
  const g = loadGallery(); galleryCountEl.textContent = g.length;
  galleryEl.innerHTML = g.map((it,idx)=>`
    <div class="card">
      <img class="thumb" src="${it.thumbDataUrl}" alt="${it.name}"/>
      <div style="margin-top:6px">${it.name}</div>
      <button class="btn small" onclick="removePerson(${idx})">ì‚­ì œ</button>
    </div>
  `).join('');
}
window.removePerson = function(i){ const g = loadGallery(); g.splice(i,1); saveGallery(g); }

/* ======= ì´ë²¤íŠ¸: ì‚¬ì§„ ì—…ë¡œë“œ ======= */
function handleFile(file){
  const img = new Image();
  img.onload = async ()=>{
    drawToCanvas(img);
    await classifyImage();
    const desc = await getFaceDescriptorFromCanvas();
    if(!desc){ matchesEl.innerHTML = '<span class="small">ì–¼êµ´ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì •ë©´ ì‚¬ì§„ì„ ì‚¬ìš©í•´ë³´ì„¸ìš”.</span>'; return; }
    const g = loadGallery();
    if(g.length===0){ matchesEl.innerHTML = '<span class="small">ê°¤ëŸ¬ë¦¬ê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤. ì•„ë˜ì—ì„œ ì‚¬ëŒ ì‚¬ì§„ì„ ì¶”ê°€í•˜ì„¸ìš”.</span>'; return; }
    // ë§¤ì¹­
    const sims = g.map(it=>{
      const sim = cosineSim(new Float32Array(it.descriptor), desc);
      return {name: it.name, sim, thumb: it.thumbDataUrl};
    }).sort((a,b)=>b.sim-a.sim).slice(0,3);
    matchesEl.innerHTML = '<b>ë‹®ì€ê¼´ TOP 3</b><br>' + sims.map(s=>`
      <div class="row" style="margin:6px 0">
        <img src="${s.thumb}" class="thumb" style="width:52px;height:52px"/>
        <div style="text-align:left">
          <div><b>${s.name}</b></div>
          <div class="small">ìœ ì‚¬ë„ ${(s.sim*100).toFixed(1)}%</div>
        </div>
      </div>
    `).join('');
  };
  img.src = URL.createObjectURL(file);
}

/* ======= ì´ë²¤íŠ¸: ê°¤ëŸ¬ë¦¬ ì‚¬ëŒ ì¶”ê°€ ======= */
async function addPerson(name, file){
  if(!name){ alert('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  const img = new Image();
  img.onload = async ()=>{
    // ìº”ë²„ìŠ¤ì— ì ì‹œ ê·¸ë ¤ì„œ ì–¼êµ´ ë²¡í„° ì¶”ì¶œ
    const off = document.createElement('canvas'); const ox=off.getContext('2d');
    const size = 300, r=Math.min(size/img.width, size/img.height,1);
    off.width = Math.round(img.width*r); off.height = Math.round(img.height*r);
    ox.drawImage(img,0,0,off.width,off.height);
    const desc = await faceapi.detectSingleFace(off, new faceapi.TinyFaceDetectorOptions({inputSize:416,scoreThreshold:0.5}))
      .withFaceLandmarks().withFaceDescriptor();
    if(!desc){ alert('ì–¼êµ´ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì •ë©´/ë‹¨ì¼ ì¸ë¬¼ ì‚¬ì§„ì„ ì‚¬ìš©í•˜ì„¸ìš”.'); return; }
    // ì¸ë„¤ì¼ ì €ì¥
    const thumb = off.toDataURL('image/jpeg', 0.92);
    const g = loadGallery();
    g.push({name, descriptor: Array.from(desc.descriptor), thumbDataUrl: thumb});
    saveGallery(g);
    alert('ê°¤ëŸ¬ë¦¬ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
  };
  img.src = URL.createObjectURL(file);
}

/* ======= ë°”ì¸ë”© ======= */
qs('#fileInput').addEventListener('change', e=>{
  const f=e.target.files?.[0]; if(f) handleFile(f);
});
qs('#demoBtn').addEventListener('click', async ()=>{
  // ê°„ë‹¨í•œ ë°ëª¨: ìƒ˜í”Œ ì´ë¯¸ì§€ë¥¼ dataURLë¡œ ìƒì„±(íšŒìƒ‰ ë°°ê²½ + í…ìŠ¤íŠ¸)
  const off=document.createElement('canvas'); off.width=512; off.height=512;
  const ox=off.getContext('2d'); ox.fillStyle='#ddd'; ox.fillRect(0,0,512,512);
  ox.fillStyle='#333'; ox.font='bold 28px sans-serif'; ox.fillText('ìƒ˜í”Œ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œ í•´ì£¼ì„¸ìš”',36,260);
  const img=new Image(); img.onload=()=>handleFile(new File([dataURLtoBlob(off.toDataURL())],'demo.png',{type:'image/png'}));
  img.src=off.toDataURL();
});
function dataURLtoBlob(dataurl){const arr=dataurl.split(','),mime=arr[0].match(/:(.*?);/)[1],bstr=atob(arr[1]);let n=bstr.length,u8=new Uint8Array(n);while(n--)u8[n]=bstr.charCodeAt(n);return new Blob([u8],{type:mime});}

qs('#refInput').addEventListener('change', e=>{
  const f=e.target.files?.[0]; const name = qs('#nameInput').value.trim();
  if(f) addPerson(name, f);
});
qs('#clearGallery').addEventListener('click', ()=>{
  if(confirm('ê°¤ëŸ¬ë¦¬ë¥¼ ëª¨ë‘ ì‚­ì œí• ê¹Œìš”?')){ localStorage.removeItem(LS_KEY); renderGallery(); }
});

/* ì´ˆê¸° ë Œë” */
renderGallery();
</script>
</body>
</html>
