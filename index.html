<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>ë‚˜ë§Œì˜ ê³„íší‘œ (ALL-IN-ONE â€¢ ëª¨ë°”ì¼ ìµœì í™” â€¢ PWA)</title>

<!-- PWA -->
<link rel="manifest" href="./manifest.webmanifest">
<meta name="theme-color" content="#22c55e">

<style>
:root{
  --bg:#f6f7fb; --card:#fff; --ink:#0f172a; --line:#e5e7eb;
  --primary:#22c55e; --primary-2:#16a34a; --danger:#ef4444;
  --muted:#6b7280;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',sans-serif; background:var(--bg); color:var(--ink);}
body.dark{--bg:#0b1220; --card:#111827; --ink:#e5e7eb; --line:#334155; --muted:#9aa3af}
.wrap{max-width:1100px; margin:0 auto; padding:16px; padding-bottom:calc(16px + env(safe-area-inset-bottom,0));}
.card{background:var(--card); border:1px solid var(--line); border-radius:16px; box-shadow:0 8px 28px rgba(2,6,23,.06); margin-bottom:16px; padding:16px;}
h1,h2{margin:0 0 .55rem}
.muted{color:var(--muted)}
button{cursor:pointer; border:0; border-radius:12px; padding:12px 14px; font-weight:700; line-height:1; min-height:44px}
.btn{background:var(--primary); color:#fff}
.btn:hover{background:var(--primary-2)}
.btn-outline{background:transparent; border:1px solid var(--line); color:var(--ink)}
.btn-danger{background:var(--danger); color:#fff}
.icon-btn{padding:10px 12px; min-width:44px}
input,select,textarea{padding:12px; border:1px solid var(--line); border-radius:12px; background:#fff; color:inherit}
body.dark input, body.dark select, body.dark textarea{background:#0f172a; border-color:#22314a}
input,select{min-height:44px}
.input-row{display:flex; gap:10px; flex-wrap:wrap}
.input-row > *{flex:1 1 180px}
ul{list-style:none; padding:0; margin:12px 0 0}
li.task{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 6px; border-bottom:1px dashed var(--line)}
li.task .text{flex:1; line-height:1.45}
li.task.completed .text{text-decoration:line-through; color:#9aa3ad}
li.task .meta{font-size:12px; color:var(--muted)}
.star{cursor:pointer; margin-left:6px; color:#bdbdbd; font-size:18px}
.star.active{color:gold}
/* ì›í˜• ì™„ë£Œìœ¨ */
.ring-wrap{position:relative; width:96px; height:96px}
.ring{--p:0; width:96px; height:96px; border-radius:50%; background:conic-gradient(var(--primary) calc(var(--p)*1%), #d1d5db 0)}
.ring::after{content:attr(data-label); position:absolute; inset:14px; border-radius:50%; background:var(--card);
 display:flex; align-items:center; justify-content:center; font-weight:800; font-size:14px}
/* ì£¼ê°„/ë‹¬ë ¥ ì»¨í…Œì´ë„ˆ: ëª¨ë°”ì¼ ê°€ë¡œ ìŠ¤í¬ë¡¤ */
.h-scroll{overflow:auto; -webkit-overflow-scrolling:touch}
.week{display:grid; grid-template-columns:repeat(7, minmax(160px,1fr)); gap:8px; min-width:1120px}
.day{border:1px solid var(--line); border-radius:12px; padding:10px; background:var(--card); display:flex; flex-direction:column; min-height:140px}
.day textarea{flex:1; resize:vertical; min-height:84px}
.calendar{display:grid; grid-template-columns:repeat(7, minmax(120px,1fr)); gap:6px; min-width:840px}
.calendar .cell{border:1px solid var(--line); border-radius:10px; padding:10px; min-height:80px}
.calendar .today{outline:2px solid #34d399; outline-offset:-2px; background:rgba(52,211,153,.12)}
.header-row{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap}
@media (max-width:840px){
  .wrap{padding:12px}
  .card{padding:12px}
  h1{font-size:20px}
  h2{font-size:17px}
  .input-row{gap:8px}
  .ring-wrap,.ring{width:84px;height:84px}
  .ring::after{inset:12px}
}
@media (max-width:520px){
  .input-row > *{flex:1 1 100%}
  .icon-btn{width:100%}
}
</style>
</head>
<body>
<div class="wrap">

  <!-- í—¤ë” / ë‹¤í¬ëª¨ë“œ / ì„¤ì¹˜ -->
  <div class="card">
    <div class="header-row">
      <div>
        <h1>âœ¨ ë‚˜ë§Œì˜ ê³„íší‘œ (ALL-IN-ONE)</h1>
        <div class="muted">ë¹ ë¥¸ ë©”ëª¨ Â· ë‚ ì§œë³„ í•  ì¼ Â· ì™„ë£Œìœ¨ Â· ì£¼ê°„ ë©”ëª¨ Â· ë‹¬ë ¥ Â· ë°˜ë³µ Â· ì•Œë¦¼ Â· ë‹¤í¬ëª¨ë“œ Â· PWA</div>
      </div>
      <div style="display:flex; gap:8px">
        <button id="darkToggle" class="btn-outline icon-btn" aria-label="ë‹¤í¬ëª¨ë“œ ì „í™˜">ğŸŒ™ ë‹¤í¬ëª¨ë“œ</button>
        <button id="installBtn" class="btn-outline icon-btn" style="display:none">ğŸ“² ì„¤ì¹˜</button>
        <button id="notifyTest" class="btn-outline icon-btn" aria-label="ì•Œë¦¼ í…ŒìŠ¤íŠ¸">ğŸ”” ì•Œë¦¼ í…ŒìŠ¤íŠ¸</button>
      </div>
    </div>
  </div>

  <!-- ê°„ë‹¨ To-Do -->
  <div class="card">
    <h2>ğŸ“ ê°„ë‹¨ ëª©í‘œ</h2>
    <div class="input-row">
      <input id="simpleTaskInput" placeholder="ë¹ ë¥¸ ë©”ëª¨ ì¶”ê°€ (íƒ­/í´ë¦­ìœ¼ë¡œ ì™„ë£Œ í‘œì‹œ)" />
      <button id="simpleAddBtn" class="btn">ì¶”ê°€</button>
    </div>
    <ul id="simpleTaskList"></ul>
  </div>

  <!-- ì˜¤ëŠ˜ì˜ ëª©í‘œ + ì™„ë£Œìœ¨ -->
  <div class="card">
    <h2>ğŸ“… ì˜¤ëŠ˜ì˜ ëª©í‘œ</h2>
    <div class="input-row">
      <input type="date" id="datePick" />
      <button id="todayBtn" class="btn-outline">ì˜¤ëŠ˜</button>
    </div>
    <div class="input-row" style="margin-top:8px">
      <input id="taskInput" placeholder="ì˜ˆ) ìš´ë™ 30ë¶„  #ê±´ê°•  (â­ì€ ì•„ë˜ ë³„ í´ë¦­)" />
      <select id="repeatSel" title="ë°˜ë³µ">
        <option value="">ë°˜ë³µ ì—†ìŒ</option>
        <option value="daily">ë§¤ì¼</option>
        <option value="weekly">ë§¤ì£¼</option>
        <option value="monthly">ë§¤ì›”</option>
      </select>
      <button id="addBtn" class="btn">ì¶”ê°€</button>
    </div>

    <ul id="taskList"></ul>

    <div class="input-row" style="margin-top:8px">
      <button id="clearDone" class="btn-outline">ì™„ë£Œ ëª¨ë‘ ì§€ìš°ê¸°</button>
      <button id="exportBtn" class="btn-outline">ë‚´ë³´ë‚´ê¸°(JSON)</button>
      <input type="file" id="importFile" accept="application/json" />
    </div>

    <div style="margin-top:12px; display:flex; align-items:center; gap:16px; flex-wrap:wrap">
      <div class="ring-wrap"><div id="ring" class="ring" data-label="0%"></div></div>
      <div id="summary" class="muted">í•  ì¼ì„ ì¶”ê°€í•´ë³´ì„¸ìš”.</div>
    </div>
  </div>

  <!-- ì£¼ê°„ ê³„íš -->
  <div class="card">
    <div class="header-row">
      <h2>ğŸ—“ ì£¼ê°„ ê³„íš</h2>
      <div class="muted" id="weekTitle"></div>
    </div>
    <div class="h-scroll"><div id="weekGrid" class="week"></div></div>
  </div>

  <!-- ë‹¬ë ¥ -->
  <div class="card">
    <h2>ğŸ“† ì›”ê°„ ë‹¬ë ¥</h2>
    <div class="h-scroll"><div id="calendar" class="calendar"></div></div>
  </div>
</div>

<script>
/* ===== ê³µí†µ ìœ í‹¸ ===== */
const $=s=>document.querySelector(s);
const fmt=d=>d.toISOString().slice(0,10);
const KEY=ymd=>"plan."+ymd;
const tagify = txt => (txt.match(/#\\S+/g)||[]);
function escapeHtml(s=''){return s.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}

/* ===== ê°„ë‹¨ To-Do ===== */
const sInput=$("#simpleTaskInput"), sBtn=$("#simpleAddBtn"), sList=$("#simpleTaskList");
sBtn.onclick=()=>{ if(!sInput.value.trim()) return;
  const li=document.createElement('li'); li.textContent=sInput.value.trim();
  li.onclick=()=>li.classList.toggle('completed');
  sList.appendChild(li); sInput.value=''; sInput.focus();
};

/* ===== ë‚ ì§œë³„ í•  ì¼ ë°ì´í„° ===== */
function load(date){return JSON.parse(localStorage.getItem(KEY(fmt(date)))||'[]')}
function save(date,arr){localStorage.setItem(KEY(fmt(date)), JSON.stringify(arr))}

/* ===== ì˜¤ëŠ˜ì˜ ëª©í‘œ UI ===== */
const taskInput=$("#taskInput"), addBtn=$("#addBtn"), taskList=$("#taskList");
const datePick=$("#datePick"), todayBtn=$("#todayBtn"), clearBtn=$("#clearDone");
const exportBtn=$("#exportBtn"), importFile=$("#importFile"), ring=$("#ring"), summary=$("#summary");
const repeatSel=$("#repeatSel");

function render(date){
  const arr=load(date); taskList.innerHTML='';
  // ì¤‘ìš”(â­) ìƒë‹¨, ì™„ë£Œ í•˜ë‹¨
  arr.sort((a,b)=> (b.star?1:0)-(a.star?1:0) || (a.done?1:0)-(b.done?1:0));
  arr.forEach((t,i)=>{
    const li=document.createElement('li'); li.className='task'+(t.done?' completed':'');
    const tags=(t.tags||[]).map(x=>`<span class="tag">${escapeHtml(x)}</span>`).join(' ');
    li.innerHTML = `
      <div style="display:flex; gap:10px; align-items:center; flex:1">
        <span class="text">${escapeHtml(t.text)}</span>
      </div>
      <div style="display:flex; align-items:center; gap:8px">
        <span class="meta">${t.repeat? 'ğŸ” '+t.repeat:''} ${tags}</span>
        <span class="star ${t.star?'active':''}" title="ì¤‘ìš” í‘œì‹œ">â˜…</span>
        <button class="btn-outline icon-btn" title="ì‚­ì œ">ì‚­ì œ</button>
      </div>`;
    li.querySelector('.text').onclick=()=>{ const a=load(date); a[i].done=!a[i].done; save(date,a); render(date); };
    li.querySelector('.star').onclick=()=>{ const a=load(date); a[i].star=!a[i].star; save(date,a); render(date); };
    li.querySelector('button').onclick=()=>{ const a=load(date); a.splice(i,1); save(date,a); render(date); };
    taskList.appendChild(li);
  });
  updateStats(date);
}

function addTask(date,text,repeat){
  const arr=load(date);
  arr.push({text,done:false,repeat,tags:tagify(text),star:false});
  save(date,arr); render(date);
}

function updateStats(date){
  const arr=load(date), total=arr.length, done=arr.filter(t=>t.done).length;
  const pct= total? Math.round(done/total*100):0;
  ring.style.setProperty('--p', pct); ring.setAttribute('data-label', pct+'%');
  summary.textContent = total? `ì´ ${total}ê°œ ì¤‘ ${done}ê°œ ì™„ë£Œ` : 'í•  ì¼ì„ ì¶”ê°€í•´ë³´ì„¸ìš”.';
}

/* ë°˜ë³µ ì¼ì •: ì˜¤ëŠ˜ ì¶”ê°€í•œ ë°˜ë³µ ì‘ì—…ì„ ì•ìœ¼ë¡œ ìƒì„± */
function applyRepeatsFrom(date){
  const base=load(date);
  const today=new Date(date);
  for(let i=1;i<=30;i++){
    const d=new Date(today); d.setDate(today.getDate()+i);
    const next=load(d);
    base.filter(t=>t.repeat).forEach(t=>{
      let doit=false;
      if(t.repeat==='daily') doit=true;
      if(t.repeat==='weekly' && d.getDay()===today.getDay()) doit=true;
      if(t.repeat==='monthly' && d.getDate()===today.getDate()) doit=true;
      if(doit && !next.some(x=>x.text===t.text && x.repeat===t.repeat)){
        next.push({...t,done:false}); localStorage.setItem(KEY(fmt(d)), JSON.stringify(next));
      }
    });
  }
}

/* ì•Œë¦¼ */
function ensureNotif(){ if('Notification' in window && Notification.permission!=='granted'){ Notification.requestPermission(); } }
function notify(msg){ if('Notification' in window && Notification.permission==='granted'){ new Notification(msg); } }
$("#notifyTest").onclick=()=>{ ensureNotif(); setTimeout(()=>notify('ì•Œë¦¼ í…ŒìŠ¤íŠ¸: ì˜ ì‘ë™í•´ìš”!'), 300); };

/* ===== ì£¼ê°„ ê³„íš ===== */
const weekGrid=$("#weekGrid"), weekTitle=$("#weekTitle");
function mondayOf(date){const d=new Date(date); const day=(d.getDay()+6)%7; d.setDate(d.getDate()-day); d.setHours(0,0,0,0); return d;}
function endOfWeek(mon){const d=new Date(mon); d.setDate(d.getDate()+6); return d;}
function loadWeek(mon){return JSON.parse(localStorage.getItem('week.'+fmt(mon))||'{}')}
function saveWeek(mon,obj){localStorage.setItem('week.'+fmt(mon), JSON.stringify(obj))}
function renderWeek(date){
  const mon=mondayOf(date); const sun=endOfWeek(mon);
  weekTitle.textContent = `${fmt(mon)} (ì›”) ~ ${fmt(sun)} (ì¼)`;
  const data=Object.assign({0:'',1:'',2:'',3:'',4:'',5:'',6:''}, loadWeek(mon));
  weekGrid.innerHTML='';
  const kor=['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† ','ì¼'];
  kor.forEach((name,i)=>{
    const box=document.createElement('div'); box.className='day';
    box.innerHTML=`<strong>${name}</strong><textarea placeholder="${name} ê³„íšì„ ì ì–´ë³´ì„¸ìš”.">${escapeHtml(data[i])}</textarea>`;
    const ta=box.querySelector('textarea');
    let t=null; ta.oninput=e=>{ clearTimeout(t); t=setTimeout(()=>{ const cur=loadWeek(mon); cur[i]=e.target.value; saveWeek(mon,cur); }, 300); };
    weekGrid.appendChild(box);
  });
}

/* ===== ë‹¬ë ¥ ===== */
const calendar=$("#calendar");
function renderCalendar(date){
  calendar.innerHTML='';
  const y=date.getFullYear(), m=date.getMonth();
  const first=new Date(y,m,1), last=new Date(y,m+1,0);
  let start=new Date(first); start.setDate(first.getDate()-((first.getDay()+6)%7)); // ì›”ìš”ì¼ ì‹œì‘
  for(let i=0;i<42;i++){
    const d=new Date(start); d.setDate(start.getDate()+i);
    const cell=document.createElement('div'); cell.className='cell';
    if(fmt(d)===fmt(new Date())) cell.classList.add('today');
    const preview=(load(d)||[]).slice(0,2).map(t=>escapeHtml(t.text)).join('<br>');
    cell.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center;">
      <strong>${d.getDate()}</strong>
      <button class="btn-outline icon-btn" aria-label="ì´ ë‚ ì§œ ë³´ê¸°">ë³´ê¸°</button>
    </div>
    <div class="muted" style="margin-top:6px; font-size:12px">${preview}</div>`;
    cell.querySelector('button').onclick=()=>{ datePick.value=fmt(d); render(d); renderWeek(d); };
    calendar.appendChild(cell);
  }
}

/* ===== ë‹¤í¬ëª¨ë“œ ===== */
$("#darkToggle").onclick=()=>{ document.body.classList.toggle('dark'); localStorage.setItem('planner.theme', document.body.classList.contains('dark')?'dark':'light'); };
(function initTheme(){ if(localStorage.getItem('planner.theme')==='dark'){ document.body.classList.add('dark'); } })();

/* ===== PWA: ì„¤ì¹˜ ë²„íŠ¼ / SW ë“±ë¡ ===== */
let deferredPrompt=null;
window.addEventListener('beforeinstallprompt', (e)=>{
  e.preventDefault(); deferredPrompt=e;
  const btn=$("#installBtn"); btn.style.display='inline-block';
});
$("#installBtn").onclick=async ()=>{
  if(!deferredPrompt) return;
  deferredPrompt.prompt();
  await deferredPrompt.userChoice;
  deferredPrompt=null;
  $("#installBtn").style.display='none';
};
// Service Worker ë“±ë¡
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=> {
    navigator.serviceWorker.register('./service-worker.js', { scope:'./' }).catch(console.error);
  });
}

/* ===== ì´ë²¤íŠ¸ ë°”ì¸ë”© ===== */
const addBtnHandler=()=>{ const text=taskInput.value.trim(); if(!text) return;
  const d=new Date(datePick.value || Date.now());
  addTask(d, text, repeatSel.value); applyRepeatsFrom(d);
  taskInput.value=''; taskInput.focus();
};
function addTask(date,text,repeat){ const arr=load(date); arr.push({text,done:false,repeat,tags:tagify(text),star:false}); save(date,arr); render(date); }

const todayBtn=$("#todayBtn");
const clearBtn=$("#clearDone");
const exportBtnEl=$("#exportBtn"), importFileEl=$("#importFile");

$("#addBtn").onclick=addBtnHandler;
$("#taskInput").addEventListener('keydown', e=>{ if(e.key==='Enter') addBtnHandler(); });
todayBtn.onclick=()=>{ const t=new Date(); t.setHours(0,0,0,0); datePick.value=fmt(t); render(t); renderWeek(t); };
datePick.onchange=()=>{ const d=new Date(datePick.value); render(d); renderWeek(d); };
clearBtn.onclick=()=>{ const d=new Date(datePick.value); save(d, load(d).filter(t=>!t.done)); render(d); };
exportBtnEl.onclick=()=>{ const d=new Date(datePick.value); const arr=load(d);
  const blob=new Blob([JSON.stringify(arr,null,2)],{type:'application/json'}); const a=document.createElement('a');
  a.href=URL.createObjectURL(blob); a.download=`plan_${fmt(d)}.json`; a.click(); };
importFileEl.onchange=e=>{ const f=e.target.files?.[0]; if(!f) return;
  const r=new FileReader(); r.onload=()=>{ try{ const arr=JSON.parse(r.result); const d=new Date(datePick.value); save(d,arr); render(d);}catch{alert('JSON í˜•ì‹ ì˜¤ë¥˜');} }; r.readAsText(f,'utf-8'); };

/* ===== ì´ˆê¸° êµ¬ë™ ===== */
(function init(){
  if('Notification' in window && Notification.permission==='default'){ Notification.requestPermission(); }
  const t=new Date(); t.setHours(0,0,0,0);
  datePick.value = fmt(t);
  render(t); renderWeek(t); renderCalendar(t);
})();
</script>
</body>
</html>
